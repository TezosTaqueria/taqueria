name: pr-update

on:
# WARNING: When working with workflow_run workflows they will only ever execute 
# what is present on the default branch in the repo. Make all the changes you 
# want here and they will not change how your PR job will run. If you want to 
# make changes to this it is best to update on the main branch itself.

  workflow_run:
    workflows: ["upload-taqueria"]
    types: [completed]

jobs:
  update_PR:
    runs-on: ubuntu-latest
    steps:
      - name: Create Artifact Download
        uses: actions/github-script@v5
        id: createArtifact
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            const {owner, repo} = context.repo
            const run_id = context.payload.workflow_run.id
            const check_suite_id = context.payload.workflow_run.check_suite_id
            
            const artifacts = await github.paginate(
              github.rest.actions.listWorkflowRunArtifacts, {owner, repo, run_id})
            
            let body = `Download the latest artifact(s) for this pull request here:\n`
            
            for (const artifact of artifacts) {
              body += `\n* [${artifact.name}.zip](https://github.com/${owner}/${repo}/suites/${check_suite_id}/artifacts/${artifact.id})`
            }

            return body

      - name: Comment Artifact to PR
        uses: actions/github-script@v5
        with:
          github-token: ${{secrets.GITHUB_TOKEN}}
          script: |
            github.rest.issues.createComment({
              issue_number: context.payload.workflow_run.pull_requests[0].number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: ${{ steps.createArtifact.outputs.result }}
            })