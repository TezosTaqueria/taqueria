#!/bin/sh
HUSKY=0

# IS A DEPLOYMENT?
if [[ -n "$TAQUERIA_DEPLOY" ]]; then
  # Get the version number from lerna.json
  VERSION=$(cat lerna.json | grep version | cut -d '"' -f 4)

  # Update the version number in the Homebrew formula (only if a stable release)
  gemini --yolo -p "Update all occurrences of version numbers in ./HomebrewFormula/taqueria.rb to version ${VERSION}. This includes the version field, the URL with v${VERSION} tag, and the TAQ_VERSION and TAQ_BUILD environment variables."

# NOT A DEPLOYMENT
else
  npx lint-staged
  git add ./deno.lock

  # Bump version # for alpha release (with timeout to prevent hanging)
  timeout 15s pnpm exec lerna version patch --no-git-tag-version --no-push --yes --force-publish || echo "Version bump completed or timed out"
  
  # Add any version changes that were made
  git add */package*.json package*.json lerna.json 2>/dev/null || true
fi